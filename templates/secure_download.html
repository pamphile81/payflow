{% extends "base.html" %}
{% block title %}Téléchargement sécurisé · PayFlow{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h1 class="h4 mb-3">Téléchargement sécurisé</h1>

        <div class="mb-3">
          <div class="text-secondary small">
            Lien pour&nbsp;: <strong>{{ employee.nom_employe if employee else 'Employé' }}</strong><br>
            Fichier&nbsp;: <strong>{{ download_link.nom_fichier }}</strong>
          </div>
        </div>

        <form id="verifyForm" action="{{ url_for('public.verify_and_download', token=download_link.token) }}" method="post">
          <div class="mb-3">
            <label class="form-label">Matricule</label>
            <input type="password" name="matricule" class="form-control" placeholder="Votre matricule" required>
            <div class="form-text text-secondary">Il s’agit du mot de passe de votre PDF.</div>
          </div>

          <div class="d-flex gap-2">
            <button id="btnVerify" class="btn btn-primary" type="submit">
              <span id="vfSpin" class="spinner" style="display:none;"></span>
              Vérifier et télécharger
            </button>
            <a class="btn btn-outline-light" href="{{ url_for('public.index') }}">Retour</a>
          </div>
        </form>

        <div id="msgBox" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const f = document.getElementById('verifyForm');
  const btn = document.getElementById('btnVerify');
  const spin = document.getElementById('vfSpin');
  const msg = document.getElementById('msgBox');

  f?.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;
    spin.style.display = 'inline-block';
    msg.innerHTML = '';

    try {
      const formData = new FormData(f);
      const res = await fetch(f.action, { method: 'POST', body: formData });
      const data = await res.json();

      if (!res.ok || !data.success) {
        btn.disabled = false;
        spin.style.display = 'none';
        msg.innerHTML = `<div class="alert alert-danger rounded-3">${data.message || 'Échec de la vérification.'}</div>`;
        return;
      }

      // Succès: redirige vers la page de succès (puis bouton de téléchargement)
      const token = "{{ download_link.token }}";
      const params = new URLSearchParams({
        token: token,
        employee_name: data.employee_name || '',
        filename: data.filename || ''
      });
      window.location.assign(`/download/success?${params.toString()}`);

    } catch (err) {
      btn.disabled = false;
      spin.style.display = 'none';
      msg.innerHTML = `<div class="alert alert-danger rounded-3">Erreur réseau. Réessayez.</div>`;
    }
  });
</script>
{% endblock %}
